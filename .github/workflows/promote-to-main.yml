name: Promote development â†’ main

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥ 09:00 JST (UTC 0:00)
  workflow_dispatch:

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if development is ahead of main
        id: check
        run: |
          git fetch origin
          AHEAD=$(git rev-list --count origin/main..origin/development 2>/dev/null || echo 0)
          echo "ahead=$AHEAD" >> $GITHUB_OUTPUT
          echo "development is ${AHEAD} commit(s) ahead of main"

      - name: Create PR development â†’ main
        if: steps.check.outputs.ahead != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh pr list --base main --head development --state open --json number --jq length)
          if [ "$EXISTING" = "0" ]; then
            DATE=$(date +%Y-%m-%d)
            gh pr create \
              --base main \
              --head development \
              --title "chore: promote development to main ($DATE)" \
              --body "## æ¦‚è¦
development ãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’ main ã¸æ˜‡æ ¼ã•ã›ã‚‹å®šæœŸ PR ã§ã™ã€‚

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] dev ç’°å¢ƒã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨
- [ ] å¤‰æ›´å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆã¿

---
ğŸ¤– GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚"
          else
            echo "æ—¢å­˜ã® open PR ãŒã‚ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi
