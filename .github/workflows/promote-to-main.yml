name: Promote develop â†’ main

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥ 09:00 JST (UTC 0:00)
  workflow_dispatch:

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if develop is ahead of main
        id: check
        run: |
          git fetch origin
          AHEAD=$(git rev-list --count origin/main..origin/develop 2>/dev/null || echo 0)
          echo "ahead=$AHEAD" >> $GITHUB_OUTPUT
          echo "develop is ${AHEAD} commit(s) ahead of main"

      - name: Create PR develop â†’ main
        if: steps.check.outputs.ahead != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh pr list --base main --head develop --state open --json number --jq length)
          if [ "$EXISTING" = "0" ]; then
            DATE=$(date +%Y-%m-%d)
            gh pr create \
              --base main \
              --head develop \
              --title "chore: promote develop to main ($DATE)" \
              --body $'## æ¦‚è¦\ndevelop ãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’ main ã¸æ˜‡æ ¼ã•ã›ã‚‹å®šæœŸ PR ã§ã™ã€‚\n\n## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ\n- [ ] dev ç’°å¢ƒã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨\n- [ ] å¤‰æ›´å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆã¿\n\n---\nğŸ¤– GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚'
          else
            echo "æ—¢å­˜ã® open PR ãŒã‚ã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi
