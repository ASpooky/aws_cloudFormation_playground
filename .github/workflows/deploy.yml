name: Deploy Lambda Stack

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: デプロイ先環境
        required: true
        default: development
        type: choice
        options:
          - development
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ (github.event_name == 'workflow_dispatch' && inputs.environment) || (github.ref_name == 'main' && 'production') || 'development' }}

    env:
      DEPLOY_BUCKET: ${{ vars.DEPLOY_BUCKET_NAME }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      STACK_NAME: ${{ vars.CFN_STACK_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      # ① デプロイ用 S3 バケットの確認・作成
      - name: Ensure deploy bucket exists
        run: |
          if aws s3api head-bucket --bucket "${DEPLOY_BUCKET}" 2>/dev/null; then
            echo "Bucket already exists: ${DEPLOY_BUCKET}"
          else
            echo "Creating bucket: ${DEPLOY_BUCKET}"
            aws s3api create-bucket \
              --bucket "${DEPLOY_BUCKET}" \
              --region "${AWS_REGION}" \
              --create-bucket-configuration LocationConstraint="${AWS_REGION}"

            aws s3api put-bucket-versioning \
              --bucket "${DEPLOY_BUCKET}" \
              --versioning-configuration Status=Enabled

            echo "Bucket created: ${DEPLOY_BUCKET}"
          fi

      # ② SAM ビルド（Lambda コードのパッケージングを自動実行）
      - name: SAM Build
        run: sam build

      # ③ SAM デプロイ（S3 アップロード・CFn デプロイを一括実行）
      - name: SAM Deploy
        run: |
          DEPLOY_DATE=$(date +%Y-%m-%d)
          sam deploy \
            --stack-name "${STACK_NAME}" \
            --s3-bucket "${DEPLOY_BUCKET}" \
            --s3-prefix "${DEPLOY_DATE}" \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --region "${AWS_REGION}"

      - name: Show stack outputs
        run: |
          aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --query "Stacks[0].{Status:StackStatus,Outputs:Outputs}" \
            --output table
